#!/bin/bash

PRIME="sglab sglab6 git@github.com git@bitbucket.org laguna datastri"
SSH_CONFIG=$(ls ~/.ssh/config)

function _usage()
{
	echo "Usage: ${0##/*/} MACHINE [-d]"
	echo "Usage: ${0##/*/} info [pattern]"
	echo "Usage: ${0##/*/} [-l] #list"
	echo "Usage: ${0##/*/} [-e]"
	grep -A100 '^#* OPTIONS #*$' $0
}

function show_ssh_config()
{
	# List of HostNames
	# grep 'Host ' $SSH_CONFIG | sed 's#Host\ \([a-z0-9\.]*\)#\1#g' | xargs echo
	
	for i in $(grep "Host .*$1" -n $SSH_CONFIG | sed 's#\([0-9]*\):.*#\1#')
	do
		sed -n $i,$(expr $i + 3)p $SSH_CONFIG \
			| sed 's#.*\ \([^\ ]*\)#\1#g' \
			| xargs printf '%s %s %s %s\n'
	done | column -t
}

function kill_all_ssh()
{
	ps aux | grep [f]NC | awk '{print $2}' | xargs kill -9
	rm $(grep ControlPath $SSH_CONFIG | awk '{print $2}' | sed "s:%[a-z]:*:g")
}

function ssh_prime()
{
	echo $PRIME | xargs -n1 -I@ -P100 ssh @ -fNC
	ps aux | grep [f]NC	
}

function list_ssh_host()
{
	grep -o -E "Host .*" $SSH_CONFIG | sed 's#Host\ ##'
}

### OPTIONS ###
case $1 in
	'')              _usage ;;
	info)            shift; show_ssh_config $@ ;;
	list|-l)         list_ssh_host ;;
	edit|-e)         vim $0 ;;
	prime|-p)        ssh_prime ;;
	kill|-k|-pk|-kp) kill_all_ssh ;;
	local)           screen -R -d -S chernjie;;
	*)
		case $2 in
			-d) ssh -v $1 ;;
			*)  ssh -v $1 -t screen -R -d -S chernjie ;;
		esac
	;;
esac
