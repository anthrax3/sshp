#!/bin/bash

PRIME="sglab sglab6 git@github.com git@bitbucket.org laguna datastri"
SSH_CONFIG=$(ls ~/.ssh/config)

function _usage()
{
	echo "Usage: ${0##/*/} MACHINE [-d]"
	echo "Usage: ${0##/*/} info [pattern]"
	echo "Usage: ${0##/*/} [-l] #list"
	echo "Usage: ${0##/*/} [-e]"
	echo "Usage: ${0##/*/} [start|status|stop] <host..>"
	grep -A100 '^#* OPTIONS #*$' $0
}

function show_ssh_config()
{
	# List of HostNames
	# grep 'Host ' $SSH_CONFIG | sed 's#Host\ \([a-z0-9\.]*\)#\1#g' | xargs echo
	
	for i in $(grep "Host .*$1" -n $SSH_CONFIG | sed 's#\([0-9]*\):.*#\1#')
	do
		sed -n $i,$(expr $i + 3)p $SSH_CONFIG \
			| sed 's#.*\ \([^\ ]*\)#\1#g' \
			| xargs printf '%s %s %s %s\n'
	done | column -t
}

function kill_ssh()
{
	local _hosts=${@:-$PRIME}
	for i in $_hosts
	do
		ssh -O check $i 2> /dev/null &&
			ssh -O exit $i
	done
}

function ssh_status()
{
	local _hosts=${@:-$PRIME}
	for i in $_hosts
	do
		ssh -O check $i
	done
}

function ssh_prime()
{
	local _hosts=${@:-$PRIME}
	for i in $_hosts
	do
		ssh -fNC $i &
	done
}

function list_ssh_host()
{
	grep -o -E "Host .*" $SSH_CONFIG | sed 's#Host\ ##'
}

### OPTIONS ###
case $1 in
	'')              _usage ;;
	edit|-e)         vim $0 ;;
	info)            shift; show_ssh_config $@ ;;
	list|-l)         list_ssh_host ;;
	prime|-p|start)  shift; ssh_prime $@ ;;
	kill|-k|stop)    shift; kill_ssh $@ ;;
	status)          shift; ssh_status $@ ;;
	local)           screen -R -d -S $(whoami) ;;
	*)
		ssh -fNC $1
		case $2 in
			-d) ssh -v $1 ;;
			*)  ssh -v $1 -t screen -R -d -S $(whoami) ;;
		esac
	;;
esac
